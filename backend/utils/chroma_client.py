from typing import Optional, Tuple
import chromadb
from chromadb.utils.embedding_functions import SentenceTransformerEmbeddingFunction
from config.settings import get_chroma_path

_CLIENT: Optional[chromadb.PersistentClient] = None
_CLIENT_PATH: Optional[str] = None
_COLLECTIONS = {}


def get_chroma_client() -> chromadb.PersistentClient:
    """Return a PersistentClient for the current chroma path.

    If the path changed since last call, re-create the client and clear cached collections.
    """
    global _CLIENT, _CLIENT_PATH, _COLLECTIONS
    path = get_chroma_path()
    if _CLIENT is None or _CLIENT_PATH != path:
        _CLIENT = chromadb.PersistentClient(path=path)
        _CLIENT_PATH = path
        _COLLECTIONS = {}
    return _CLIENT


def get_collection(name: str, embedding_function=None):
    global _COLLECTIONS
    key = (name, id(embedding_function))
    if key in _COLLECTIONS:
        return _COLLECTIONS[key]
    client = get_chroma_client()
    coll = client.get_or_create_collection(name=name, embedding_function=embedding_function)
    _COLLECTIONS[key] = coll
    return coll

